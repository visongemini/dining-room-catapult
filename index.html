<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Mess Fight</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            background: #202020;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
        }
        #game-container {
            position: relative;
            width: 100%;
            max-width: 450px;
            height: 100%;
            max-height: 850px;
            background: #f0e6d2;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        canvas { width: 100%; height: 100%; display: block; }
        
        /* UI Top Bar */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; z-index: 100; pointer-events: none;
        }
        .ui-group { display: flex; gap: 10px; pointer-events: auto; }
        .pixel-btn {
            background: #fff; border: 4px solid #000;
            padding: 5px; cursor: pointer; font-size: 16px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.2);
        }
        .pixel-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 rgba(0,0,0,0.2); }
        .version-tag {
            font-size: 10px; color: rgba(0,0,0,0.5); 
            background: rgba(255,255,255,0.8); padding: 4px; border-radius: 4px;
        }

        /* Overlay Dialogs */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 200; display: none; text-align: center; color: #fff;
        }
        .dialog-box {
            background: #fff; color: #000; border: 4px solid #000;
            padding: 20px; width: 85%; max-width: 350px;
            box-shadow: 10px 10px 0 #000;
        }
        .dialog-box h2 { font-size: 18px; margin-bottom: 15px; line-height: 1.4; color: #e74c3c; }
        .dialog-box p { font-size: 12px; line-height: 1.6; margin-bottom: 20px; }
        .action-btn {
            background: #3498db; color: #fff; border: 4px solid #000;
            padding: 15px 30px; font-family: 'Press Start 2P'; font-size: 14px;
            cursor: pointer; display: inline-block;
        }
        .action-btn:hover { background: #2980b9; }

        /* Floating Text */
        .float-text {
            position: absolute; font-size: 12px; font-weight: bold;
            pointer-events: none; animation: floatUp 1s forwards;
            text-shadow: 2px 2px 0 #000;
        }
        @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }

        /* Ending Scene */
        #ending-scene {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: #2c1e1e; display: none; z-index: 300;
            flex-direction: column; justify-content: center; align-items: center;
        }
        #ending-canvas { width: 300px; height: 300px; image-rendering: pixelated; }
    </style>
</head>
<body>

<div id="game-container">
    <!-- UI Layer -->
    <div class="top-bar">
        <div class="ui-group">
            <div class="pixel-btn" id="music-btn">ðŸ”‡</div>
            <div class="pixel-btn" id="lang-btn">CN</div>
        </div>
        <div class="version-tag">V1.0</div>
    </div>

    <!-- Game Canvas -->
    <canvas id="world"></canvas>

    <!-- Dialogs -->
    <div id="dialog-overlay" class="overlay">
        <div class="dialog-box">
            <h2 id="dialog-title">TITLE</h2>
            <p id="dialog-text">Content goes here...</p>
            <button class="action-btn" id="dialog-btn">START</button>
        </div>
    </div>

    <!-- Ending -->
    <div id="ending-scene">
        <h2 style="color:#f1c40f; margin-bottom:20px; text-shadow:4px 4px 0 #000;">HAPPY ENDING</h2>
        <canvas id="ending-canvas" width="300" height="300"></canvas>
        <p id="ending-text" style="color:#fff; margin-top:20px; font-size:10px; line-height:2; text-align:center; padding:20px;">
            Visonä¸ŽMattå¼€æ€€ç•…é¥®<br>å…¨å®¶å›¢åœ†
        </p>
    </div>
</div>

<script>
/**
 * FAMILY MESS FIGHT - V1.0
 * Powered by Gemini 3 Pro
 */

// --- Localization & Config ---
const LANG = {
    cn: {
        musicOn: "ðŸ”Š", musicOff: "ðŸ”‡",
        stage1_title: "å®¶åº­é¤åŽ…å¤§ä¹±æ–—å¼€å§‹ï¼",
        stage1_text: "ç”¨å¼¹å¼“å‘å°„ç‰©å“ï¼Œå‡»ä¸­éœ²å‡ºè„¸éƒ¨çš„å®¶äººå§ï¼\n30ä»¶æ™®é€šé“å…·ç”¨å®ŒåŽï¼Œå°†å¼€å¯æ— é™å¤§ä¾¿æ¨¡å¼ï¼",
        stage1_btn: "å¼€å§‹ä¹±æ–—",
        stage2_title: "Mattçš„å¦»å­Lolaè¢«æƒŠåŠ¨äº†ï¼",
        stage2_text: "å¥¹æ˜¯ä¸€ä½ç¥žç§˜çš„å®¶åº­å¥³å·«ï¼Œåªä¼šé—ªé¿ï¼Œä¸ä¼šæ”»å‡»ï¼\nå‡»è´¥å¥³å·«ï¼Œè®©å¥¹æ¢å¤æˆæ™®é€šäººå§ï¼",
        stage2_btn: "è¿Žæˆ˜å¥³å·«",
        stage2_win_title: "é­”æ³•è§£é™¤ï¼",
        stage2_win_text: "Lolaæ¢å¤æˆæ¸©æŸ”çš„æ­£å¸¸äººï¼Œä¸ŽMattç´§ç´§ç›¸æ‹¥ã€‚\nä¸€å®¶äººå³å°†è¿Žæ¥å’Œå¹³â€¦â€¦ä½†çœŸæ­£çš„å±æœºæ‰åˆšåˆšå¼€å§‹ï¼",
        stage2_win_btn: "ç»§ç»­...",
        stage3_title: "è­¦å‘Šï¼Visonå½»åº•é»‘åŒ–ï¼",
        stage3_text: "é»‘åŒ–Visonæˆä¸ºè¶…çº§å¤§é­”çŽ‹ï¼Œå¼€å§‹æ”»å‡»å…¨å®¶ï¼\nçŽ°åœ¨ï¼Œä½ ä»¬äº”äººå¿…é¡»å¹¶è‚©ä½œæˆ˜ï¼Œç”¨äº”æŠŠå¼¹å¼“å…¨åŠ›åå‡»ï¼\nå¤§ä¾¿å·²å‡çº§ä¸ºå·¨ç¡¬å¤§ä¾¿Ã—200æ”»å‡»åŠ›ï¼",
        stage3_btn: "æœ€ç»ˆå†³æˆ˜",
        ending_text: "é—¹å‰§ç»“æŸï¼Œé»‘æš—æ¶ˆæ•£ï¼\nVisonæ¢å¤æ­£å¸¸ï¼Œä¸ŽMattä¸€èµ·æŠ½ç€é›ªèŒ„ã€å–ç€å¨å£«å¿Œã€‚\nCocoã€Colaã€Vinaã€Lolaåœ¨èº«åŽå¹¸ç¦æ¬¢ç¬‘ã€‚",
        poop_unlocked: "æ— é™å¤§ä¾¿æ¨¡å¼å·²å¯åŠ¨ï¼",
        ammo: "å‰©ä½™é“å…·",
        score: "å¾—åˆ†"
    },
    en: {
        musicOn: "ðŸ”Š", musicOff: "ðŸ”‡",
        stage1_title: "Family Restaurant Chaos Begins!",
        stage1_text: "Use the slingshot to hit family members!\nUnlock Infinite Poop Mode after 30 items!",
        stage1_btn: "START",
        stage2_title: "Witch Lola Appears!",
        stage2_text: "She only dodges and never attacks!\nDefeat the witch to save her!",
        stage2_btn: "FIGHT WITCH",
        stage2_win_title: "Magic is Lifted!",
        stage2_win_text: "Lola returns to normal.\nBut the real crisis has just begun!",
        stage2_win_btn: "CONTINUE...",
        stage3_title: "WARNING! EVIL VISON!",
        stage3_text: "Vison is consumed by darkness!\nUse 5 slingshots to fight back!\nSuper Hard Poop (200 ATK) unlocked!",
        stage3_btn: "FINAL BATTLE",
        ending_text: "Chaos ends! Vison & Matt drink whiskey.\nThe family lives happily ever after.",
        poop_unlocked: "Infinite Poop Mode ON!",
        ammo: "Items",
        score: "Score"
    }
};

const CFG = {
    w: 450, h: 800,
    colors: { bg: '#f0e6d2', floor: '#8d6e63', furniture: '#5d4037' },
    gravity: 1.2
};

// --- Game Engine ---
const App = {
    lang: 'cn',
    audio: false,
    engine: null, world: null,
    stage: 0, // 0:Menu, 1:Mess, 2:Lola, 3:Vison, 4:End
    score: 0,
    ammo: 30,
    poopMode: false,
    projectiles: [],
    targets: [],
    boss: null,
    slingshots: [], // For Stage 3
    activeTouches: new Map(), // Multi-touch ID -> Slingshot Index
    
    // Assets (Pixel Art Generators)
    art: {
        // Simple 8-bit shapes
        drawPoop: (ctx, x, y, size, isHard) => {
            ctx.save(); ctx.translate(x, y);
            const c = isHard ? '#3e2723' : '#795548';
            ctx.fillStyle = c;
            // Pyramid shape for poop
            ctx.fillRect(-size/2, size/2, size, size/3);
            ctx.fillRect(-size/3, 0, size/1.5, size/2);
            ctx.fillRect(-size/4, -size/2, size/2, size/2);
            if(isHard) { // "200" text
                ctx.fillStyle = '#f1c40f'; ctx.font='8px Arial'; ctx.fillText('200', -6, 5);
            }
            ctx.restore();
        },
        drawFace: (ctx, x, y, name, isEvil) => {
            ctx.save(); ctx.translate(x, y);
            // Head
            ctx.fillStyle = '#ffcc80'; ctx.fillRect(-15, -15, 30, 30);
            // Hair
            ctx.fillStyle = name==='Lola'?'#8e44ad': name==='Vison'?'#2c3e50': '#d35400';
            ctx.fillRect(-17, -20, 34, 10);
            // Eyes
            ctx.fillStyle = isEvil ? '#e74c3c' : '#000';
            ctx.fillRect(-8, -5, 4, 4); ctx.fillRect(4, -5, 4, 4);
            // Mouth
            ctx.fillStyle = '#000';
            if(isEvil) { ctx.fillRect(-5, 5, 10, 3); } // Angry
            else { ctx.fillRect(-3, 5, 6, 2); } // Neutral
            
            if(name === 'Vison' && isEvil) {
                // Horns
                ctx.fillStyle = '#c0392b';
                ctx.beginPath(); ctx.moveTo(-10,-15); ctx.lineTo(-15,-25); ctx.lineTo(-5,-15); ctx.fill();
                ctx.beginPath(); ctx.moveTo(10,-15); ctx.lineTo(15,-25); ctx.lineTo(5,-15); ctx.fill();
            }
            ctx.restore();
        }
    }
};

// --- Initialization ---
function init() {
    const cvs = document.getElementById('world');
    cvs.width = CFG.w; cvs.height = CFG.h;
    const ctx = cvs.getContext('2d');

    // Matter.js
    const Engine = Matter.Engine, World = Matter.World, Runner = Matter.Runner;
    App.engine = Engine.create();
    App.world = App.engine.world;
    App.engine.gravity.y = CFG.gravity;

    // Boundaries
    const walls = [
        Matter.Bodies.rectangle(CFG.w/2, CFG.h+50, CFG.w, 100, { isStatic: true, label: 'floor' }),
        Matter.Bodies.rectangle(-50, CFG.h/2, 100, CFG.h, { isStatic: true }),
        Matter.Bodies.rectangle(CFG.w+50, CFG.h/2, 100, CFG.h, { isStatic: true })
    ];
    World.add(App.world, walls);

    // Collision
    Matter.Events.on(App.engine, 'collisionStart', handleCollisions);

    // Input
    setupInput(cvs);

    // Loop
    (function loop() {
        Matter.Engine.update(App.engine, 1000/60);
        updateLogic();
        render(ctx);
        requestAnimationFrame(loop);
    })();

    // Start UI
    showDialog('stage1');
}

// --- Game Logic Updates ---
function updateLogic() {
    // Boss AI (Stage 2)
    if(App.stage === 2 && App.boss) {
        // Lola teleports randomly
        if(Math.random() < 0.02) {
            Matter.Body.setPosition(App.boss.body, {
                x: 50 + Math.random()*(CFG.w-100),
                y: 100 + Math.random()*200
            });
            createParticles(App.boss.body.position.x, App.boss.body.position.y, '#8e44ad');
        }
    }

    // Boss AI (Stage 3)
    if(App.stage === 3 && App.boss) {
        const b = App.boss;
        // Float
        Matter.Body.translate(b.body, { x: Math.sin(Date.now()/500)*2, y: Math.sin(Date.now()/300) });
        
        // Attack
        if(Math.random() < 0.01) {
            // Throw darkness
            const p = Matter.Bodies.circle(b.body.position.x, b.body.position.y+30, 10, {
                label: 'boss_projectile', density: 0.1
            });
            Matter.World.add(App.world, p);
            Matter.Body.setVelocity(p, { x: (Math.random()-0.5)*5, y: 10 });
        }
    }
}

// --- Stage Management ---
function loadStage(n) {
    App.stage = n;
    // Cleanup
    App.projectiles.forEach(p => Matter.World.remove(App.world, p));
    App.projectiles = [];
    
    if(n === 1) { // Mess Fight
        App.ammo = 30;
        App.poopMode = false;
        // Targets
        createTarget(100, 400, 'Coco');
        createTarget(350, 400, 'Cola');
        createTarget(225, 300, 'Vina');
        createTarget(225, 500, 'Matt');
        // Slingshot
        App.slingshots = [{x: CFG.w/2, y: 700, anchor:{x:CFG.w/2, y:700}, active:false}];
    }
    else if(n === 2) { // Lola
        App.ammo = 999;
        App.poopMode = true; // Inherit
        // Boss Lola
        App.boss = createBoss('Lola', 2000, 150);
        App.slingshots = [{x: CFG.w/2, y: 700, anchor:{x:CFG.w/2, y:700}, active:false}];
    }
    else if(n === 3) { // Vison
        // Clear all
        Matter.World.clear(App.world);
        // Rebuild Walls
        World = Matter.World; // Re-ref
        const walls = [
            Matter.Bodies.rectangle(CFG.w/2, CFG.h+50, CFG.w, 100, { isStatic: true, label: 'floor' }),
            Matter.Bodies.rectangle(-50, CFG.h/2, 100, CFG.h, { isStatic: true }),
            Matter.Bodies.rectangle(CFG.w+50, CFG.h/2, 100, CFG.h, { isStatic: true })
        ];
        Matter.World.add(App.world, walls);

        App.ammo = 999;
        App.poopMode = true; // Super Poop
        
        // 5 Slingshots
        App.slingshots = [];
        const names = ['Coco','Cola','Vina','Matt','Lola'];
        for(let i=0; i<5; i++) {
            const x = 50 + i * ((CFG.w-100)/4);
            App.slingshots.push({
                x: x, y: 700, anchor: {x:x, y:700},
                owner: names[i],
                hp: 100,
                active: false
            });
        }
        
        // Boss Vison
        App.boss = createBoss('Vison', 10000, 100);
    }
}

function createTarget(x, y, name) {
    const body = Matter.Bodies.rectangle(x, y, 40, 40, { isStatic: true, label: 'target' });
    body.name = name;
    App.targets.push(body);
    Matter.World.add(App.world, body);
}

function createBoss(name, hp, y) {
    const body = Matter.Bodies.circle(CFG.w/2, y, 40, { isStatic: true, label: 'boss', isSensor: true });
    Matter.World.add(App.world, body);
    return { name, hp, maxHp: hp, body, width: 80 };
}

// --- Rendering ---
function render(ctx) {
    // BG
    ctx.fillStyle = CFG.colors.bg;
    ctx.fillRect(0, 0, CFG.w, CFG.h);
    
    // Slingshots
    App.slingshots.forEach(s => {
        if(s.hp !== undefined && s.hp <= 0) return; // Dead
        
        // Band
        ctx.beginPath();
        ctx.moveTo(s.anchor.x-20, s.anchor.y);
        ctx.lineTo(s.x, s.y);
        ctx.lineTo(s.anchor.x+20, s.anchor.y);
        ctx.strokeStyle = '#3e2723'; ctx.lineWidth = 4; ctx.stroke();
        
        // Holder (Y shape)
        ctx.strokeStyle = '#5d4037'; ctx.lineWidth = 6;
        ctx.beginPath(); 
        ctx.moveTo(s.anchor.x, s.anchor.y+30); ctx.lineTo(s.anchor.x, s.anchor.y);
        ctx.moveTo(s.anchor.x-20, s.anchor.y-20); ctx.lineTo(s.anchor.x, s.anchor.y);
        ctx.lineTo(s.anchor.x+20, s.anchor.y-20);
        ctx.stroke();
        
        // Character Name (Stage 3)
        if(App.stage === 3) {
            ctx.fillStyle = '#000'; ctx.font = '10px Arial'; ctx.textAlign='center';
            ctx.fillText(s.owner, s.anchor.x, s.anchor.y+45);
            // HP Bar
            ctx.fillStyle = '#f00'; ctx.fillRect(s.anchor.x-15, s.anchor.y+50, 30, 4);
            ctx.fillStyle = '#0f0'; ctx.fillRect(s.anchor.x-15, s.anchor.y+50, 30*(s.hp/100), 4);
        }
        
        // Dragging Item
        if(s.active) {
            const isHard = (App.stage === 3);
            App.art.drawPoop(ctx, s.x, s.y, isHard?30:20, isHard);
        }
    });

    // Targets (Stage 1)
    App.targets.forEach(t => {
        const p = t.position;
        App.art.drawFace(ctx, p.x, p.y, t.name, false);
    });

    // Boss
    if(App.boss && App.boss.hp > 0) {
        const b = App.boss;
        const p = b.body.position;
        
        // Aura
        ctx.fillStyle = b.name==='Lola' ? 'rgba(142, 68, 173,0.3)' : 'rgba(192, 57, 43,0.3)';
        ctx.beginPath(); ctx.arc(p.x, p.y, 60, 0, Math.PI*2); ctx.fill();
        
        App.art.drawFace(ctx, p.x, p.y, b.name, b.name==='Vison'); // Vison is Evil
        
        // HP Bar
        const pct = b.hp / b.maxHp;
        ctx.fillStyle = '#000'; ctx.fillRect(p.x-50, p.y-70, 100, 10);
        ctx.fillStyle = b.name==='Lola'?'#8e44ad':'#c0392b'; ctx.fillRect(p.x-50, p.y-70, 100*pct, 10);
    }

    // Projectiles
    App.projectiles.forEach(p => {
        const isHard = (App.stage === 3);
        App.art.drawPoop(ctx, p.position.x, p.position.y, isHard?30:20, isHard);
    });
}

// --- Input Handling (Multi-touch!) ---
function setupInput(cvs) {
    const getScale = () => ({ x: cvs.width/cvs.getBoundingClientRect().width, y: cvs.height/cvs.getBoundingClientRect().height });

    const handleStart = (id, x, y) => {
        const scale = getScale();
        const touchX = x * scale.x;
        const touchY = y * scale.y;

        // Find closest active slingshot
        App.slingshots.forEach((s, idx) => {
            if(s.hp !== undefined && s.hp <= 0) return;
            const dist = Math.hypot(touchX - s.anchor.x, touchY - s.anchor.y);
            if(dist < 60) {
                App.activeTouches.set(id, idx);
                s.active = true;
                s.x = touchX; s.y = touchY;
            }
        });
    };

    const handleMove = (id, x, y) => {
        if(App.activeTouches.has(id)) {
            const idx = App.activeTouches.get(id);
            const s = App.slingshots[idx];
            const scale = getScale();
            
            // Limit drag
            const dx = x*scale.x - s.anchor.x;
            const dy = y*scale.y - s.anchor.y;
            const dist = Math.hypot(dx, dy);
            const maxDist = 100;
            
            if(dist > maxDist) {
                const angle = Math.atan2(dy, dx);
                s.x = s.anchor.x + Math.cos(angle)*maxDist;
                s.y = s.anchor.y + Math.sin(angle)*maxDist;
            } else {
                s.x = x*scale.x; s.y = y*scale.y;
            }
        }
    };

    const handleEnd = (id) => {
        if(App.activeTouches.has(id)) {
            const idx = App.activeTouches.get(id);
            fire(idx);
            App.activeTouches.delete(id);
        }
    };

    // Mouse
    cvs.addEventListener('mousedown', e => handleStart(-1, e.clientX - cvs.getBoundingClientRect().left, e.clientY - cvs.getBoundingClientRect().top));
    window.addEventListener('mousemove', e => handleMove(-1, e.clientX - cvs.getBoundingClientRect().left, e.clientY - cvs.getBoundingClientRect().top));
    window.addEventListener('mouseup', e => handleEnd(-1));

    // Touch
    cvs.addEventListener('touchstart', e => {
        e.preventDefault();
        for(let i=0; i<e.changedTouches.length; i++) {
            const t = e.changedTouches[i];
            handleStart(t.identifier, t.clientX - cvs.getBoundingClientRect().left, t.clientY - cvs.getBoundingClientRect().top);
        }
    }, {passive:false});
    
    cvs.addEventListener('touchmove', e => {
        e.preventDefault();
        for(let i=0; i<e.changedTouches.length; i++) {
            const t = e.changedTouches[i];
            handleMove(t.identifier, t.clientX - cvs.getBoundingClientRect().left, t.clientY - cvs.getBoundingClientRect().top);
        }
    }, {passive:false});
    
    cvs.addEventListener('touchend', e => {
        for(let i=0; i<e.changedTouches.length; i++) handleEnd(e.changedTouches[i].identifier);
    });
}

function fire(idx) {
    const s = App.slingshots[idx];
    s.active = false;
    
    const dx = s.anchor.x - s.x;
    const dy = s.anchor.y - s.y;
    const power = Math.min(Math.hypot(dx, dy), 100) * 0.15;
    const angle = Math.atan2(dy, dx);
    
    // Reset slingshot visual
    s.x = s.anchor.x; s.y = s.anchor.y;

    const isHard = (App.stage === 3);
    const body = Matter.Bodies.circle(s.anchor.x, s.anchor.y, isHard?15:10, {
        label: 'projectile', density: 0.05, friction: 0.5, restitution: 0.6
    });
    body.isHard = isHard;
    body.damage = isHard ? 200 : 50;
    
    Matter.World.add(App.world, body);
    Matter.Body.setVelocity(body, { x: Math.cos(angle)*power*15, y: Math.sin(angle)*power*15 });
    
    App.projectiles.push(body);
    
    // SFX
    playSound(isHard ? 'thud' : 'poop');
    
    // Ammo
    if(!App.poopMode) {
        App.ammo--;
        if(App.ammo <= 0) {
            App.poopMode = true;
            createFloatText(CFG.w/2, CFG.h/2, LANG[App.lang].poop_unlocked, '#8d6e63');
        }
    }
}

// --- Physics Events ---
function handleCollisions(e) {
    e.pairs.forEach(pair => {
        const a = pair.bodyA, b = pair.bodyB;
        let proj = (a.label === 'projectile') ? a : (b.label === 'projectile') ? b : null;
        let other = (proj === a) ? b : a;
        if(!proj) return;

        // Hit Target (Stage 1)
        if(other.label === 'target') {
            createParticles(other.position.x, other.position.y, '#ffcc80');
            Matter.World.remove(App.world, other);
            App.targets = App.targets.filter(t => t !== other);
            if(App.targets.length === 0) showDialog('stage2');
        }
        
        // Hit Boss
        if(other.label === 'boss') {
            App.boss.hp -= proj.damage;
            createFloatText(other.position.x, other.position.y, `-${proj.damage}`, '#f00');
            if(App.boss.hp <= 0) {
                Matter.World.remove(App.world, App.boss.body);
                if(App.stage === 2) showDialog('stage2_win');
                if(App.stage === 3) playEnding();
            }
        }
    });
}

// --- UI & Utils ---
function showDialog(id) {
    const el = document.getElementById('dialog-overlay');
    const title = document.getElementById('dialog-title');
    const text = document.getElementById('dialog-text');
    const btn = document.getElementById('dialog-btn');
    const L = LANG[App.lang];
    
    el.style.display = 'flex';
    
    const config = {
        'stage1': { t: L.stage1_title, c: L.stage1_text, b: L.stage1_btn, act: () => loadStage(1) },
        'stage2': { t: L.stage2_title, c: L.stage2_text, b: L.stage2_btn, act: () => loadStage(2) },
        'stage2_win': { t: L.stage2_win_title, c: L.stage2_win_text, b: L.stage2_win_btn, act: () => showDialog('stage3') },
        'stage3': { t: L.stage3_title, c: L.stage3_text, b: L.stage3_btn, act: () => loadStage(3) }
    };
    
    const c = config[id];
    title.textContent = c.t;
    text.innerText = c.c;
    btn.textContent = c.b;
    btn.onclick = () => { el.style.display = 'none'; c.act(); };
}

function createFloatText(x, y, txt, color) {
    const d = document.createElement('div');
    d.className = 'float-text'; d.textContent = txt; d.style.color = color;
    d.style.left = x+'px'; d.style.top = y+'px';
    document.getElementById('game-container').appendChild(d);
    setTimeout(() => d.remove(), 1000);
}

function createParticles(x, y, color) {
    // Simplified particle effect
}

function playEnding() {
    document.getElementById('ending-scene').style.display = 'flex';
    document.getElementById('ending-text').innerText = LANG[App.lang].ending_text;
    
    const cvs = document.getElementById('ending-canvas');
    const ctx = cvs.getContext('2d');
    
    // Draw Vison & Matt
    ctx.fillStyle = '#3e2723'; ctx.fillRect(50, 150, 200, 50); // Sofa
    App.art.drawFace(ctx, 100, 140, 'Vison', false);
    App.art.drawFace(ctx, 200, 140, 'Matt', false);
    
    // Cigars
    ctx.fillStyle = '#fff'; ctx.fillRect(110, 145, 10, 2); ctx.fillRect(190, 145, -10, 2);
    // Whiskey
    ctx.fillStyle = '#f1c40f'; ctx.fillRect(130, 180, 10, 15); ctx.fillRect(160, 180, 10, 15);
}

// --- Audio (Simple Synth) ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(type) {
    if(!App.audio) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    
    if(type === 'poop') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        osc.start(); osc.stop(audioCtx.currentTime + 0.3);
    } else if(type === 'thud') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(100, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 0.5);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
        osc.start(); osc.stop(audioCtx.currentTime + 0.5);
    }
}

// UI Bindings
document.getElementById('music-btn').onclick = function() {
    App.audio = !App.audio;
    this.textContent = App.audio ? LANG[App.lang].musicOn : LANG[App.lang].musicOff;
    if(App.audio) audioCtx.resume();
};

document.getElementById('lang-btn').onclick = function() {
    App.lang = App.lang === 'cn' ? 'en' : 'cn';
    this.textContent = App.lang.toUpperCase();
    // Refresh texts would require reload logic, for now simpler to just update ending/dialogs dynamically
};

// Start
init();

</script>
</body>
</html>